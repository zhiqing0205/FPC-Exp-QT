# misfit_uniform_time_seed_fftw_early.cpp 概览（实验 CLI）

## 程序在做什么
- 使用 MPI + FFTW 的 3D 周期域谱方法（网格 1920 × 1920 × 1）模拟双场相场晶体/密度波模型：`phi` 表示序参量/密度波幅度，`con` 表示组分。
- 自由能包含：局域多项式（控制晶相/液相势阱）、组分混合熵（对数项）、卷积核 `C2A/C2B` 引入的晶格特征波矢选择性，以及梯度/弹性能；可叠加噪声项。
- 初始条件：全域先置为均匀值，然后在 `grainx × grainy × grainz` 的子块中心叠加随机取向的余弦密度波，形成多晶/多畴结构。
- 时间推进：半隐式谱格式。实空间算非线性与混合项，频域处理卷积与扩散（`MAINEQUATIONC2_NOI`），可选噪声过滤；每步逆变换回实空间并归一化。
- 输出：周期性写入 VTK（分块 `.vti` + 汇总 `.pvti`）、能量与密度统计、原子位置 CFG、径向分布函数、Q6 有序参数等。

## 主要流程（高层步骤）
1. 初始化 MPI/FFTW，分配所有实/频域数组和 FFT 计划。
2. 构建 k-空间波矢 `krefl/krefm/krefn`（根据 `dx` 和域长）。
3. `INITIAL_dis`：设置均匀背景（`u0`, `con0`），再按子块中心叠加随机取向的晶格余弦波。
4. 预计算卷积核 `C2AK/C2BK`（以 `sig`、`ka*`、`kb*`、`gaa*`、`gab*` 等确定波矢选择）。
5. 初始场输出 VTK。
6. 时间循环 `t = 0 … Tend-1`：
   - 计算局域非线性 `UPDATEINN3`、混合熵 `UPDATEINFMIX`、卷积驱动力 `UPDATEINFCMIX`，合并成 `inn/inc`。
   - FFT 到频域，得到 `outn/outc`；加入噪声（`Gauss`→`MAINEQUATIONC2_NOI`）。
   - 半隐式更新频域 `phiHat/conHat`（扩散/动力学系数随 k²、k⁴）。
   - 计算梯度能相关项 `UPDATEINC2GRA`。
   - IFFT 回实空间并除以网格体积归一。
   - 重新做一次卷积（供能量/诊断），并按 `mod` 步执行峰值定位、检查点时间戳、可选输出。
7. 循环结束，关闭文件，销毁计划并释放内存。

## 方程与数值要点
- `phi` 的局域势：`(phi^2)/2 - (niu/6) phi^3 + (ksi/12) phi^4`，决定双稳态。
- 组分混合熵：`(phi+1) * para_w * [c ln(c/para_c0) + (1-c) ln((1-c)/(1-para_c0))]`。
- 卷积项：频域乘以核 `C2A/C2B`，再回实空间，根据组分权重组合，体现不同晶格的首选波矢。
- 梯度/扩散：频域更新含 `ks = kx^2 + ky^2 + kz^2`，`phi` 用 k²，`con` 用 k⁴（`para_alpha`）。
- 噪声：`Gauss` 生成白噪声，频域加权 `(0.5-0.5*tanh((|k|-2π)/0.1))` 过滤高频，并乘 `b0` 强度。

## 输出与诊断
- 场数据：每个进程写 `phi_<t>_<rank>.vti` / `con_<t>_<rank>.vti`，`PVTKWRITE/PVTKWRITEC` 生成 `.pvti` 汇总。
- 分析：`energy.txt`（平均能量、密度），`phiball_<t>.cfg`（等值面提取的原子位置），`hist_*` / `Grq6_*`（RDF），`Ql_*` / `HistQ_*`（局域/全局 Q6）。
- 切片/线：`SLICE` 输出固定截面，`LINEF` 输出线剖面。

## 关键初始参数（第 106 行及附近）
- `u0=0.05`：`phi` 均值/液相基线，影响初始密度波中心和峰值阈值。
- `sig=0.05`：卷积核整体衰减因子，越大核越平滑、对特征波矢选择性降低。
- `con0=0.2`：初始组分，决定混合熵基线，并参与初始化晶格波矢混合 `((1-con0)*ka0 + con0*kb0)`。
- `dt=0.05`：时间步长，进入半隐式分母；越大演化更快但稳定性降低。
- `dx=0.125`：空间步长，设定物理尺度与 k-空间分辨率，影响噪声强度标度 `b0 = sqrt(axx/dx^3/dt)`。

## 相关控制参数（紧随其后）
- 核形状：`gaa1/gaa2`（A 相高斯宽度）、`gab1/gab2`（B 相），决定核尖锐度；`ka0/ka1/ka2`、`kb0/kb1/kb2` 为特征波矢。
- 局域势：`niu=1.4`、`ksi=1.0` 设置双稳态深度/非线性强度。
- 动力学系数：`dynamic_mn=0.1`（`phi` 扩散系数 k²），`dynamic_mc=10.`（`con` k⁴），`para_alpha=0.5`（k⁴ 权重），`para_w=0.02`（混合熵权重），`para_c0=0.5`（对称组分）。
- 初始纹理：`grainx=80, grainy=80, grainz=1` 控制种子晶粒排布；子块尺寸 `dnx/dny/dnz`。
- 噪声：`axx`（基准强度，默认 0），`b0 = sqrt(axx/dx^3/dt)`；`lam` 备用尺度，`mod` 控制输出频率。
- 诊断阈值：`phi_rat=0.618`（由 `phimax_atmposi` 设定等值面），`bench_*` 设定判据下/上限。

## 调参与理解建议
- 稳定性：调大 `dt` 或调小 `dx` 时需同步检查 `dynamic_mn/mc` 与核宽度 `sig/gaa/gab`，避免高频放大。
- 结构尺度：目标晶格常数由 `ka*/kb*` 与 `dx` 共同决定，改变 `dx` 需同时调整波矢以保持物理尺度。
- 成分/相分离：`para_c0`、`para_w` 控制混合驱动力；`con0` 设定初始偏析。
- 噪声：通过 `axx`（进而 `b0`）决定噪声强度，默认关闭；打开后配合 `mod` 提高输出频率便于监控。
